# 權證資訊爬蟲系統

基於 Playwright 的台股權證資訊爬蟲系統，支援命令列查詢和 LINE Bot 整合。

## 功能特色

- ✅ 自動爬取 HiStock 權證資訊
- ✅ 支援分頁遍歷（自動偵測最後一頁）
- ✅ 可篩選特定券商（如：元大、統一等）
- ✅ 限制爬取頁數避免過長等待
- ✅ 失敗重試機制（最多 3 次，延遲 1-3 秒）
- ✅ Headless/有界面雙模式
- ✅ 常用查詢設定檔支援
- ✅ LINE Bot 整合（快查/普查）

## 專案結構

```
stock.warrants/
├── scraper.py              # 核心爬蟲程式
├── run.py                  # 執行腳本（支援設定檔）
├── config.json             # 常用查詢設定
├── config.example.json     # 設定檔範例
├── pyproject.toml          # uv 專案設定
├── .env.example            # 環境變數範本
├── linebot/                # LINE Bot 模組
│   ├── bot.py              # Flask 主程式
│   ├── handlers.py         # 查詢處理器
│   ├── commands.py         # 指令解析器
│   └── LINEBOT_README.md   # LINE Bot 文件
└── README.md               # 本文件
```

## 安裝與設定

### 1. 環境需求

- Python 3.11+
- uv（Python 套件管理工具）

### 2. 安裝依賴

```bash
# 安裝專案依賴
uv sync

# 安裝 Playwright 瀏覽器
uv run playwright install chromium
```

### 3. 設定常用查詢（可選）

編輯 `config.json` 設定常用的篩選條件：

```json
{
  "headless": true,
  "max_pages": 3,
  "filter_name": "元大"
}
```

## 使用方式

### 方法 1：直接使用爬蟲

```bash
# 基本用法：查詢股票代號 6669
uv run scraper.py 6669

# 使用 headless 模式（背景執行）
uv run scraper.py 6669 --headless

# 限制爬取頁數
uv run scraper.py 6669 --max-pages 5

# 篩選特定券商
uv run scraper.py 6669 --filter-name 元大

# 組合使用
uv run scraper.py 6669 --headless --max-pages 3 --filter-name 元大
```

#### 參數說明

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `stock_code` | 股票代號（必填） | - |
| `--headless` | 背景執行，不顯示瀏覽器 | False |
| `--max-pages N` | 限制爬取最大頁數 | 全部 |
| `--filter-name TEXT` | 篩選權證名稱包含的文字 | 無 |

### 方法 2：使用執行腳本（推薦）

執行腳本會讀取 `config.json` 設定檔，適合常用查詢。

```bash
# 使用預設設定檔查詢股票 6669
uv run run.py 6669

# 普通查詢模式（無篩選，查全部）
uv run run.py 2330 -n

# 使用自訂設定檔
uv run run.py 6669 -c my_config.json

# 查看說明
uv run run.py --help
```

#### 範例輸出

```
================================================================================
查詢設定
================================================================================
股票代號: 6669
Headless 模式: True
爬取頁數: 3 頁
篩選條件: 權證名稱包含 "元大"
================================================================================

2025-11-06 15:00:00 - INFO - 開始爬取股票代號: 6669
2025-11-06 15:00:05 - INFO - 第 1/24 頁，本頁 0 筆，累計 0 筆
2025-11-06 15:00:08 - INFO - 第 2/24 頁，本頁 3 筆，累計 3 筆
2025-11-06 15:00:11 - INFO - 第 3/24 頁，本頁 2 筆，累計 5 筆

================================================================================
權證資料爬取結果
================================================================================
權證名稱|代號|價格|價內外|剩餘天數
--------------------------------------------------------------------------------
緯穎元大59購03|036805|1.9|價外 10.65%|315
緯穎元大59購02|036583|3.33|價外 6.8%|314
緯穎元大59購01|035852|2.14|價外 0.35%|308
緯穎元大57購02|042558|1.26|價外 24.67%|267
緯穎元大57購01|039525|3.08|價外 11.38%|244
================================================================================
統計資訊:
  總筆數: 5
  失敗頁數: 0
================================================================================
```

## LINE Bot 整合

本系統支援 LINE Bot 整合，讓你可以透過 LINE 查詢權證資訊。

### 功能

- **快查**：篩選特定券商（元大）+ 前 3 頁
- **查詢**：全部券商 + 全部頁面
- **價外查詢**：只顯示價外權證（價內外 < 0%）+ 可自訂頁數

### 使用指令

```
快查 6669       → 元大權證，前3頁
查詢 2330       → 全部權證，全部頁面
價外 6669       → 價外權證，全部頁面
價外 6669 5     → 價外權證，指定前5頁
幫助            → 顯示說明
```

### 設定步驟

1. **建立 LINE Bot**
   - 前往 [LINE Developers Console](https://developers.line.biz/)
   - 建立 Messaging API Channel
   - 取得 Channel Access Token 和 Channel Secret

2. **設定環境變數**
   ```bash
   cp .env.example .env
   # 編輯 .env 填入憑證
   ```

3. **啟動 Bot**
   ```bash
   uv run python -m linebot.bot
   ```

4. **設定 Webhook**
   - 使用 ngrok 建立公開 URL：`ngrok http 5000`
   - 在 LINE Developers 設定 Webhook URL：`https://your-domain.com/callback`

詳細說明請參考 [LINE Bot 文件](linebot/LINEBOT_README.md)

## 設定檔說明

### config.json

常用查詢設定檔，`run.py` 會自動讀取。

```json
{
  "headless": true,         // 是否使用 headless 模式
  "max_pages": 3,           // 限制爬取頁數（null = 全部）
  "filter_name": "元大"     // 篩選券商（null = 不篩選）
}
```

### 設定檔範例

參考 `config.example.json` 查看更多設定範例：

```json
{
  "examples": {
    "元大權證": {
      "headless": true,
      "max_pages": null,
      "filter_name": "元大"
    },
    "統一權證前5頁": {
      "headless": true,
      "max_pages": 5,
      "filter_name": "統一"
    },
    "無篩選全部資料": {
      "headless": false,
      "max_pages": null,
      "filter_name": null
    }
  }
}
```

## 技術架構

### 核心技術

- **Playwright**: 瀏覽器自動化
- **asyncio**: 非同步執行
- **argparse**: 命令列參數解析
- **Flask**: LINE Bot Web 框架
- **line-bot-sdk**: LINE Messaging API

### 爬蟲流程

1. 啟動 Playwright 瀏覽器（Chromium）
2. 導航至目標 URL（動態組合股票代號和頁碼）
3. 等待權證表格載入
4. 偵測「最後一頁」元素，判斷總頁數
5. 逐頁解析表格，提取權證資訊
6. 根據篩選條件過濾資料
7. 失敗時自動重試（最多 3 次，延遲 1-3 秒）
8. 輸出結果（終端機或 LINE Bot）

### 欄位說明

爬取的權證資訊包含以下欄位：

| 欄位 | 說明 | 範例 |
|------|------|------|
| 權證名稱 | 完整權證名稱 | 緯穎元大59購03 |
| 代號 | 權證代號 | 036805 |
| 價格 | 當前價格 | 1.9 |
| 價內外 | 價內外程度 | 價外 10.65% |
| 剩餘天數 | 到期剩餘天數 | 315 |

## 價外權證查詢

### 什麼是價外權證？

權證的價內外程度表示標的價格與履約價格的差距：

- **價內（In-the-Money）**：價內外 > 0%，對買方有利，但權利金較貴
- **平價（At-the-Money）**：價內外 = 0%，履約價等於現價
- **價外（Out-of-the-Money）**：價內外 < 0%，對買方不利，但權利金較便宜

價外權證因權利金較低，槓桿效果更大，但風險也相對較高。

### 使用方式

#### LINE Bot 查詢

```
價外 6669       # 查詢股票 6669 的所有價外權證（全部頁面）
價外 6669 5     # 查詢股票 6669 的價外權證（只查前 5 頁）
價外 2330 10    # 查詢股票 2330 的價外權證（只查前 10 頁）
```

#### 範例回應

```
📉 價外查詢結果 (價外（<0%）)
找到 15 筆價外權證（前5頁）
==============================

📊 元大6669購01
代號: 070123 | 價格: 0.45
價內外: -3.2%
剩餘天數: 45
──────────────────────────────

📊 凱基6669購02
代號: 070234 | 價格: 0.38
價內外: -5.8%
剩餘天數: 62
──────────────────────────────

⚠️ 僅顯示前 10 筆
總共 15 筆資料
```

### 技術說明

價外查詢使用 `OutOfMoneyWarrantScraper` 類別，它會：
1. 爬取指定股票的權證資料
2. 自動篩選包含「價外」文字的權證
3. 可自訂查詢頁數以控制查詢時間
4. 支援與其他查詢相同的重試機制

詳細實作請參考 [價外查詢功能說明](價外查詢功能說明.md)。

## 常見問題

### Q: 爬蟲速度很慢？

A: 使用 `--max-pages` 限制頁數，或使用 `--filter-name` 篩選特定券商減少資料量。

### Q: 出現 Timeout 錯誤？

A: 網路速度較慢時可能發生，系統會自動重試 3 次。如持續失敗，請檢查網路連線。

### Q: Headless 模式無法執行？

A: 確認已安裝 Chromium：`uv run playwright install chromium`

### Q: 如何篩選多個券商？

A: 目前僅支援單一關鍵字篩選。如需多個條件，建議先爬取全部資料，再自行過濾。

### Q: 資料會儲存嗎？

A: 目前僅顯示在終端機。如需儲存，可將輸出重導向至檔案：
```bash
uv run scraper.py 6669 > output.txt
```

## 開發計畫

### 已完成 ✅
- [x] 基礎爬蟲功能
- [x] 分頁遍歷
- [x] 券商篩選
- [x] 重試機制
- [x] 常用查詢設定檔
- [x] LINE Bot 整合
- [x] 價外權證查詢（可自訂頁數）

### 待開發 🚧
- [ ] CSV/Excel 匯出
- [ ] 資料庫儲存
- [ ] 用戶個人設定（LINE Bot）
- [ ] Flex Message 美化（LINE Bot）
- [ ] 查詢歷史記錄
- [ ] 定時推送功能
- [ ] Web 介面
- [ ] Docker 容器化

## Docker 部署

本專案支援 Docker 容器化部署。

### 快速開始

```bash
# 1. 複製環境變數範本
cp .env.docker .env

# 2. 編輯 .env 填入 LINE Bot 憑證
nano .env

# 3. 啟動服務
docker-compose up -d

# 4. 查看日誌
docker-compose logs -f
```

### Docker Compose 服務

- **web**: LINE Bot 主服務（Port 5000）
- **nginx**: 反向代理（Port 80/443，可選）

詳細說明請參考 [Docker 部署指南](DOCKER.md)

### 使用 Nginx 反向代理

```bash
docker-compose --profile with-nginx up -d
```

## 授權

MIT License

## 貢獻

歡迎提交 Issue 或 Pull Request！

## 聯絡方式

- GitHub: [@13g7895123](https://github.com/13g7895123)
- Repository: [stock.warrant](https://github.com/13g7895123/stock.warrant)

---

**注意事項**：
- 本工具僅供學習研究使用
- 請遵守目標網站的使用條款
- 爬取頻率請控制在合理範圍內
- 投資有風險，資訊僅供參考
