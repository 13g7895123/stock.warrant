# 價外判斷邏輯更新說明

## 📌 變更摘要

將價外權證的判斷邏輯從「數值計算」改為「文字匹配」，使判斷方式更簡單直觀。

## 🔄 變更內容

### 原本的判斷邏輯（數值計算）
```python
def is_out_of_money(self, moneyness_str: str) -> bool:
    # 解析數值，判斷是否 < 0
    moneyness_str = moneyness_str.strip().replace('%', '').replace(' ', '')
    moneyness = float(moneyness_str)
    return moneyness < 0
```

**問題：**
- 需要解析數值
- 可能遇到格式問題
- 依賴數值正負判斷

### 新的判斷邏輯（文字匹配）✨
```python
def is_out_of_money(self, moneyness_str: str) -> bool:
    # 簡單判斷：只要包含「價外」就是價外權證
    return '價外' in moneyness_str
```

**優點：**
- ✅ 簡單直觀
- ✅ 不需要解析數值
- ✅ 完全依照網站顯示的文字
- ✅ 容錯性更高

## 📊 測試結果

執行 `test_outofmoney.py` 測試：

```
============================================================
測試價外權證判斷邏輯
============================================================
✓ PASS | 輸入:  價外 10.65% | 期望: True  | 結果: True  | 包含價外文字應為價外
✓ PASS | 輸入:    價外 5.2% | 期望: True  | 結果: True  | 包含價外文字應為價外
✓ PASS | 輸入:    價外 0.5% | 期望: True  | 結果: True  | 包含價外文字應為價外
✓ PASS | 輸入:    價內 3.1% | 期望: False | 結果: False | 包含價內文字不是價外
✓ PASS | 輸入:    價內 5.8% | 期望: False | 結果: False | 包含價內文字不是價外
✓ PASS | 輸入:         平價 | 期望: False | 結果: False | 平價不是價外
✓ PASS | 輸入:          0% | 期望: False | 結果: False | 純數字不是價外
✓ PASS | 輸入:       -5.2% | 期望: False | 結果: False | 負值但無價外文字不算
✓ PASS | 輸入:       +3.1% | 期望: False | 結果: False | 正值且無價外文字不算
============================================================
測試結果: 9 通過, 0 失敗
============================================================
```

**✅ 全部測試通過！**

## 📝 更新的檔案

1. ✅ `scraper.py` - 更新 `is_out_of_money()` 方法
2. ✅ `test_outofmoney.py` - 更新測試案例
3. ✅ `README.md` - 更新技術說明
4. ✅ `價外查詢功能說明.md` - 更新判斷邏輯說明
5. ✅ `CHANGELOG_價外查詢.md` - 更新價內外說明

## 🎯 判斷規則

| 欄位內容 | 是否為價外 | 說明 |
|---------|----------|------|
| 價外 10.65% | ✅ 是 | 包含「價外」文字 |
| 價外 5.2% | ✅ 是 | 包含「價外」文字 |
| 價外 0.5% | ✅ 是 | 包含「價外」文字 |
| 價內 3.1% | ❌ 否 | 包含「價內」文字 |
| 價內 5.8% | ❌ 否 | 包含「價內」文字 |
| 平價 | ❌ 否 | 平價不是價外 |
| 0% | ❌ 否 | 純數字不算 |
| -5.2% | ❌ 否 | 沒有「價外」文字 |

## 💡 為什麼這樣改？

1. **符合網站顯示**：HiStock 網站直接顯示「價外 X%」或「價內 X%」
2. **更加可靠**：不依賴數值解析，避免格式問題
3. **易於理解**：判斷邏輯一目了然
4. **維護簡單**：只需要一行程式碼

## ✨ 使用範例

```python
# LINE Bot 查詢
價外 6669       # 查詢所有包含「價外」文字的權證
價外 6669 5     # 查詢前 5 頁包含「價外」文字的權證
```

查詢結果會包含所有價內外欄位顯示為「價外 X%」的權證。

---

**更新日期**：2025-11-27
**測試狀態**：✅ 全部通過
**向後相容**：✅ 完全相容
